#  概述
##  编写目的
介绍A100平台上的Demo软件项目概要设计。
## 适用范围
适用范围为全志T507平台。
## 参考人员
本文档的参考人员为全志P616项目的开发和维护人员。

# 术语、缩略语及概念
## netlink
netlink是用以实现用户进程和内核进程的一种特殊通信机制，也是网络应用程序与内核通信的最常用的接口。    
Netlink 是一种特殊的 socket，它是 Linux 所特有的，类似于 BSD 中的AF_ROUTE 但又远比它的功能强大，目前在Linux 内核中
## HASH校验
散列函数（或散列算法，又称哈希函数，英语：Hash Function）是一种从任何一种数据中创建小的数字“指纹”的方法。散列函数把消息或数据压缩成摘要，使得数据量变小，将数据的格式固定下来。该函数将数据打乱混合，重新创建一个叫做散列值（hash values，hash codes，hash sums，或hashes）的指纹。散列值通常用来代表一个短的随机字母和数字组成的字符串。  
hash校验即通过比较两个文件或字符串的散列值去判断两者是否相等。
# 背景
## 项目需求
### 客户需求
软件Demo包含后台服务应用 A、客户端应用 B、客户端应用 C和内核模块 K四个独立组件。K作为A和B、A和C之间的通信中转站，B和C之间不能通信。软件Demo主要有以下功能。  
Demo功能1：A和B发生一次通信，A将数据包编码后发送给K，K受到数据包转发给B，B对数据包完成逆向解码还原，并将原始数据的HASH值字符串通过K返还给A。A受到HASH值字符串进行正确性校验，校验成功完成通信，校验失败后Log日志抛出异常码ERN110。  
Demo功能2：同理A和C发生通信过程如上，校验失败后Log日志抛出异常码ERN120。
### 限制条件
+ 规格   
  软件开发：保证解耦设计，可被二次定制，具有一定的鲁棒性     
  代码规范：代码风格符合SWC和SW4的代码规范要求，使用git进行统一的管理    
  测试：各个模块支持多种方便、单独的调试手段，支持临时数据的调试，支持命令调试    
  文档：符合软件设计文档规范，并需在内部评审通过    
+ 交付说明   
  代码：提交至git仓库——SWC-Bootcamp    
  文档：上传至edoc，具体文档包括：虚拟项目任务计划书，软件概要设计文档，各个组件 的测试列表、测试报告，各个模块代码的静态代码检查报告，组件之间的联调报告，代码的 ROM/RAM分析报告，开发、调试过程的记录文档，总结文档。  

# 各模块功能及源码结构

# 公共模块
## 编解码模块
编解码模块的功能包括：数据编码和数据解码。  
+ 数据编码  
对发送的字符串编码
+ 数据解码  
对编码字符串进行解码还原
## hash模块
hash模块的功能包括：字符串hash值计算、文件hash值计算和hash值校验。  
+ 字符串hash值计算  
计算字符串的hash值
+ 文件hash值计算  
计算文件的hash值  
+ hash值校验  
将原始文件的hash值字符串和收到的hash值字符串进行比较以确认文件的一致性。
## 封装模块
封装模块的功能包括：数据封装和数据解封。
+ 数据封装  
将待发送的数据、发送者、接受者和消息类型等信息一起封装起来。  
+ 数据解封  
对封装数据进行解封、获取发送者、接受者、消息类型和数据内容等信息。  
## netlink模块
netlink模块的功能包括：netlink初始化、netlink套接字创建、netlink地址绑定、消息发送和消息接收。
+ netlink初始化    
完成客户端和服务端的netlink套接字创建地址初始化与绑定
+ netlink套接字创建  
创建用户态netlink地址套接字
+ netlink地址绑定  
将netlink套接字与相关的地址进行绑定  
+ 消息发送  
完成用户态netlink消息发送  
+ 消息接收  
完成用户态netlink消息接收  
## 连接控制模块
连接控制模块的功能包括：连接确认和ID获取。  
+ 连接确认  
根据客户端的连接请求确定是否进行连接
+ ID获取  
获取客户端的prot ID号
# 服务端模块A
后台服务应用A，包括三个子功能，分别是连接控制、发送数据、接收数据、HASH校验模块和文件传输。 
+ 连接控制  
服务端根据客户端的连接请求消息控制连接是否建立
+ 发送数据  
服务端可主动向客户端发送消息
+ 接收数据：   
接收来自内核模块K转发的数据 
+ HASH校验   
根据HASH值完成HASH校验，如果成功则完成通信，失败则抛出异常码ERN120或ERN110
+ 文件传输
服务端作为被动的文件中转站，客户端可下载服务端的文件，也可以向服务端上传文件
# 内核模块K
内核模块K的功能包括：接收数据、数据转发和状态监测
+ 接收数据  
接收来自应用程序的数据，识别出数据的来源和去向
+ 数据转发  
如果通信合法，将收到到的数据转发给接收者  
如果通信非法，将数据丢弃并返回非法信息  
+ 状态监测  
定期对应用程序进程的运行状态进行检测，通过dmesg打印出来  
+ 调试节点
# 客户端模块B/C
客户端的功能包括连接请求、发送数据、接收数据、hash校验、文件下载和文件上传
+ 连接请求  
客户端在与服务端通信之前要发送连接请求进行连接，连接成功方可通信    
+ 发送数据  
客户端可主动给服务端发送数据  
+ 接收数据  
接收来自内核转发的数据  
+ hash校验  
对文件或消息的hash值进行校验确保发送接收无误
+ 文件上传  
向服务端上传文件
+ 文件下载  
从服务端目录下载文件
# 源码树结构
```
├── docs                        项目相关文档目录
├── hdr                         头文件目录
│   ├── codec.h                 编解码头文件
│   ├── connect.h               连接控制模块头文件    
│   ├── encapsulation.h         封装模块头文件
│   ├── hash.h                  hash模块头文件
│   ├── netlink.h               netlink模块头文件
│   └── protocol.h              协议相关头文件
├── kernelspace                 内核源码目录
│   ├── kernel_k.c              内核模块k源码
│   ├── Kconfig                 编译相关配置文件
│   └── Makefile                编译相关配置文件
├── lib                         依赖的外部库
│   ├── include
│   └── lib
├── out                         编译产物目录
│   ├── client_b
│   ├── client_c
│   ├── kernel_k.ko
│   └── server_a
├── README.md                   
├── script                      脚本文件目录
│   └── build.sh
├── src                         源文件目录
│   ├── client_b.c              客户端b源码
│   ├── client_c.c              客户端c源码
│   ├── codec.c                 编解码模块源码
│   ├── connect.c               连接控制模块源码
│   ├── encapsulation.c         封装模块源码
│   ├── hash.c                  hash模块源码
│   ├── Makefile                编译Makefile
│   ├── netlink.c               netlink模块源码    
│   └── server_a.c              服务端a源码
└── test                        测试文件目录
    ├── codec_test
    ├── file_test
    ├── hash_test
    ├── netlink_file
    ├── pack_test
    └── socket_file
```

# 模块概要
## 软件整体体系结构

![整体体系结构](figures/p1_Demo整体结构.png)

Demo通信软件主要由四个子模块组成，分别是后台服务应用A、客户端应用B、客户端应用C和内核模块K。除了四个子模块之外有五个公共模块：编解码模块、HASH计算模块、封装模块、连接控制模块和netlink模块。客户端服务端调用公共模块与内核模块产生通信。
## 模块流程
### 数据编解码流程
### 数据封装与解封流程
### 数据hash计算流程
### netlink初始化流程
### 客户端与服务端建立连接流程
### 客户端与服务端发送消息流程
### 客户端文件上传流程
### 客户端下载文件流程
### 内核模块k消息转发流程
### 内核模块应用检测流程
### 内核模块调试节点统计通信次数流程

## 外部接口
### 编解码模块
### 连接控制模块
### 封装模块
### hash模块
### netlink模块

# Debug流程
## 各模块netlink初始化
## 编码和解码功能
## 数据封装与解封
## hash计算
## 消息通信debug
## 文件传输debug

# 出错处理
## 容错处理
## 函数返回值有效性校验
## 应用运行状态监测

# 总结



